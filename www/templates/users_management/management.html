{% extends "../base.html" %}

{% block title %}ВолКомХоз: Управление пользователями{% end %}

{% block body %}

<div class="container-fluid" id="parent">
	<h2 class="col-md-12" style="margin:20px 0">Управление пользователями</h2>
	<!-- if the user has made action (delete, edit, add) -->
	{% if suc_msg %}
		<script>
			suc_act_msg = {
				'del' : 'Пользователь успешно удален',
				'edit': 'Пользователь успешно отредактирован',
				'add' : 'Пользователь успешно добавлен'
			};

			var msg_text = suc_act_msg['{{ suc_msg }}'];
			if (msg_text) 
				$('#parent').append('<div class="col-md-12 alert alert-success" role="alert" id="suc_msg"></div>')
				$('#suc_msg').text(msg_text).css("font-weight","Bold");
		</script>
	{% end %}
	<div class="col-md-8">
		<!-- table of the users -->
		<table class="table table-hover" id="users_table">
			<thead>
				<tr>
					<th>№</th>
					<th>Имя</th>
					<th>Почта</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{% for i, user in enumerate(users) %}
					<tr class="um-clickable-row" data-toggle="collapse" data-target="#row_details_{{ i }}" class="accordion-toggle" data-user-id="{{ user[0] }}">
						<td>{{ i+1 + num_in_page*(page-1) }}</td>
						<td class="long_text"><span>{{ user[1] }}</span></td>
						<td class="long_text"><span>{{ user[2] }}</span></td>
						<td>
							<a id="popover_rights_{{ user[0] }}" tabindex="0" class="btn btn-lg btn-info btn-sm" role="button" data-trigger="hover" style="width: 100px">
							Права <span class="badge">{{ user[3] }}</span>
							</a>
						</td>
					</tr>
					<!-- bootstrap popover with rights -->
					<div id='rights_content_{{ user[0] }}' style="display: none; color: #333; text-decoration: none;">
						{% set no_rights = True %}
						{% for index, key in enumerate(pers) %}
							{% if int(user[3]) & pers[key][0] %}
								{% set no_rights = False %}
								<div class="alt_back_div bg-info" style="padding: 3px;">
									{{ pers[key][1] }}
								</div>
								{% if index != len(pers)-1 %}
									<hr style="margin: 1px">
								{% end %}	
							{% end %}
						{% end %}
						{% if no_rights %}
							Нет прав на данном сайте
						{% end %}
					</div>
					<script>
						// alternative color for rights in popover
						$('.alt_back_div:odd').removeClass('bg-info').addClass('bg-warning');

						$(function(){
							// Enables popover
							$("#popover_rights_{{ user[0] }}").popover({
								html : true, 
								content: function() {
									return $("#rights_content_{{ user[0] }}").html();
								}
							});
						});
					</script>
				{% end %}
			</tbody>
		</table>

		<!-- PAGINATOR -->
		<ul class="pagination">
			<li class="page-item {% if page == 1 %} disabled {% end %}">
				<a class="page-link" onclick="prev_button_click(this)" id="prev_link" {% if page == 1 %} disabled {% end %}>Назад</a>
			</li>
		</li>
		{% for i in range(num_of_pages) %}
		{% if i+1 == page %}
		<li class="page-item active">
			{% else %}
			<li class="page-item">
				{% end %}
				<a class="page-link" href="/users_management?page={{ i+1 }}">{{ i+1 }}</a>
			</li>
			{% end %}
			<li class="page-item {% if page == num_of_pages %} disabled {% end %}">
				<a class="page-link" onclick="next_button_click(this)" id="next_link" {% if page == num_of_pages %} disabled {% end %}>Вперед</a>
			</li>
		</ul>
	</div>

	<!-- delete, edit, add buttons -->
	{% set enable_edit = current_user['rights'] & pers['can_edit_users'][0] %}
	{% if enable_edit %}
	<div class="col-md-2">
		<a href="#" onclick="click_button_add()" class="btn btn-lg btn-block btn-success" data-toggle="modal" data-target="#modal_form">Добавить</a>
		<a href="#" onclick="delete_user()" class="btn btn-lg btn-block btn-danger user_selected" disabled>Удалить</a>
		<a href="#" onclick="click_button_edit()" class="btn btn-lg btn-block btn-warning user_selected" data-toggle="modal" data-target="#modal_form" disabled>Редактировать</a>
	</div>
	{% end %}

	<!-- the hidden form for deleting a user -->
	<form style="display: hidden" action="/users_management?page={{ page -	int(not (len(users)-1) % num_in_page) }}" method="POST" id="user_form_delete">
		<input type="hidden" id="action" name="action"/>
		<input type="hidden" id="id" name="id"/>
	</form>
	<script>
		// delete button's click handler
		function delete_user() {
			user_id = $('#users_table').find('.bg-primary').attr('data-user-id');
			
			if (!user_id)
				return;

			var ok = confirm("Вы уверены? Действие нельзя будет отменить!");
			if (!ok)
				return;

			document.getElementById('action').value = 'del';
			document.getElementById('id').value = user_id;
			$("#user_form_delete").submit();
		}
	</script>

	<!-- form for adding and deleting a users -->
	<form id="user_form" method="POST" action="/users_management?action=add">
		<!-- modal for adding and editing -->
		<div class="modal fade" id="modal_form" role="dialog">
			<div class="modal-dialog">

				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" id="modal_header"></h4>
					</div>
					<div class="modal-body">


						<!-- form NAME -->
						<div class="form-group col-md-12" style="float: none">
							<label class="control-label" for="name_user">
								Имя
							</label>
							<div class="input-group col-md-12">
								<span class="input-group-addon">
									<i class="glyphicon glyphicon-user"></i>
								</span>
								<input type="text" class="form-control" id="name_user" name="name" placeholder="Имя" pattern="^[A-Za-zА-Яа-яЁё0-9]+(?:[ _-][A-Za-zА-Яа-яЁё0-9]+)*$" required autofocus>
							</div>
						</div>

						<!-- form EMAIL -->
						<div class="form-group col-md-12" style="float: none">
							<label class="control-label" for="email_user">
								Email
							</label>
							<div class="input-group col-md-12">
								<span class="input-group-addon" role="input">
									<i class="glyphicon glyphicon-envelope"></i>
								</span>
								<input type="email" class="form-control" id="email_user" name="email" placeholder="Email" required>
							</div>
						</div>

						<!-- form OLD PASSWORD for editing-->
						<div class="form-group col-md-12" id="old_password_edit" style="float: none">
							<label class="control-label" for="old_password_user">
								Старый пароль
							</label>
							<div class="input-group col-md-12">
								<span class="input-group-addon">
									<i class="glyphicon glyphicon-lock"></i>
								</span>
								<input type="password" class="form-control" id="old_password_user" name="old_password" placeholder="Старый пароль">
							</div>
						</div>

						<!-- form PASSWORD -->
						<div class="form-group col-md-12" style="float: none">
							<label class="control-label" for="password_user">
								Пароль
							</label>
							<div class="input-group col-md-12">
								<span class="input-group-addon">
									<i class="glyphicon glyphicon-lock"></i>
								</span>
								<input type="password" class="form-control" id="password_user" name="password" placeholder="Пароль">
							</div>
						</div>

						<!-- form CONFIRM PASSWORD -->
						<div class="form-group col-md-12" style="float: none">
							<label class="control-label" for="confirm_password_user">
								Повторите пароль
							</label>
							<div class="input-group col-md-12">
								<span class="input-group-addon">
									<i class="glyphicon glyphicon-lock"></i>
								</span>
								<input type="password" class="form-control" id="confirm_password_user" name="confirm_password" placeholder="Повторите пароль">
							</div>
						</div>

						<!-- form RIGHTS -->
						<div class="form-group col-md-12" style="float: none;">
							<table class="col-md-12" style="float: none">
								<tr>
									{% for index, key in enumerate(pers) %}
									<td><div class="checkbox">
										<label>
											<input type="hidden" id="{{ key }}_hidden" name="{{ key }}" value="False">
											<input type="checkbox" id="{{ key }}_showen" name="{{ key }}" value="True">{{ pers[key][1] }}
										</label>
									</div></td>
									{% if index % 2 %}
								</tr>
								<tr>
									{% end %}
									{% end %}
								</tr>
							</table>
						</div>

						<script>
							var name_input = document.getElementById("name_user");

							// set custom validate errors for 'name' input
							function validate_name(){
								var value = name_input.value;
								var pattern = new RegExp(name_input.pattern);
								if (value.length > {{ max_name_length }}) {
									name_input.setCustomValidity("Длина поля должна быть меньше " + max_name_length + "!");
								} 
								else if (!pattern.test(value)) {
									name_input.setCustomValidity("Имя может состоять из латинских букв, русских букв, цифр, пробела, нижнего подчеркивания и тире, причем начинаться должно с буквы или цифры!");
								}
								else {
									name_input.setCustomValidity('');
								}
							}

							name_input.onkeyup = validate_name;

						</script>
						<script>
							var password = document.getElementById("password_user");
							var confirm_password = document.getElementById("confirm_password_user");

							// set custom validate errors for 'email' input
							function validate_password(){
								if(password.value != confirm_password.value) {
									confirm_password.setCustomValidity("Пароли не совпадают!");
								} else {
									confirm_password.setCustomValidity('');
								}
							}

							password.onchange = validate_password;
							confirm_password.onkeyup = validate_password;
						</script>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Отменить</button>
						<button type="submit" class="btn btn-default" id="submit_button"></button>
					</div>
				</div>

			</div>
		</div>
	</form>
	<script>
		var user_form = document.getElementById('user_form');

		// submit button click for add a user
		function add_user() {
			var url = "/users_management?action=add&page={{ num_of_pages + 	int(not len(users) % num_in_page) }}";
			user_form.action = url;
		}

		// submit button click for edit a user
		function edit_user(event) {
			var url = "/users_management?action=edit&id=" + event.data.user_id + "&page={{ page }}";
			user_form.action = url;
		}

		// click button 'add user'
		function click_button_add() {
			document.getElementById('submit_button').innerText = 'Добавить';
			document.getElementById('modal_header').innerText = 'Добавление пользователя';
			document.getElementById('old_password_edit').style.display = 'none';
			document.getElementById('password_user').required = true;
			document.getElementById('confirm_password_user').required = true;

			set_user_data('', '', 0);
			user_form.addEventListener('submit', add_user);
		}

		// click button 'edit user'
		function click_button_edit() {
			document.getElementById('submit_button').innerText = 'Сохранить';
			document.getElementById('modal_header').innerText = 'Редактирование пользователя';
			document.getElementById('old_password_edit').style.display = 'block';
			document.getElementById('password_user').required = false;
			document.getElementById('confirm_password_user').required = false;

			user_id = $('#users_table').find('.bg-primary').attr('data-user-id');

			if (!user_id) {
				return;
			}

			fill_inputs_form(user_id);

			$('#user_form').on('submit', {
				user_id:user_id
			}, edit_user);
		}

		// fill inputs with data from db (name, email, rights)
		function fill_inputs_form(user_id) {
			var name = '';
			var email = '';
			var rights = 0;
			if (user_id) {
				var users = {% raw users %};
				var user = find_by_id(users, user_id);
				if (user) {
					name   = user[1];
					email  = user[2];
					rights = user[3];
				}
			}

			set_user_data(name, email, rights);
		}

		// set input's value: name, email, rights
		function set_user_data(name, email, rights) {
			document.getElementById('name_user').value = name;
			document.getElementById('email_user').value = email;

			{% for i, p in enumerate(pers) %}
				var value = Boolean({{ pers[p][0] }} & rights);
				$('#{{ p }}_showen').prop('checked', value);
			{% end %}
		}

		// find elem in arr
		function find_by_id(arr, elem) {
			for (var i = 0; i < arr.length; i++) {
				if (arr[i][0].toString() === elem) {
					return arr[i];
				}
			}
			return null;
		}
	</script>

	<!-- select/unselect the row of a table-->
	<script>
		function unselect(html_el) {
			$(html_el).removeClass('bg-primary');

			$('.user_selected').attr('disabled', true);
			$('.user_selected').on("click", function() {
				return false; 
			});
		}

		unselect();

		$('#users_table').on('click', '.um-clickable-row', function(event) {
			if($(this).hasClass('bg-primary')){
				unselect(this);
			} else {
				$(this).addClass('bg-primary').siblings().removeClass('bg-primary');
				$('.user_selected').removeAttr('disabled').off('click');
			}
		});

		$(document).on('click', function(event) {
			if (!$(event.target).closest('#users_table').length &&
				!$(event.target).hasClass('user_selected')) 
			{
<<<<<<< HEAD
				unselect('.um-clickable-row');
			}
		});
=======
				unselect('.um-clickable-row');user, editing email added
			}
		});

		function CreateGetRequestEmail(email) {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', '/users_management?email=' + email, true);
			xhr.send();
		}
>>>>>>> Users management
	</script>

	<!-- generate a href for NEXT and PREV button -->
	<script>
		disabled_element("#prev_link");
		disabled_element("#next_link");

		function next_button_click(a) {
			current_page = parseInt($('.pagination').find('.active').text());

			var href_value = '';
			if (current_page && current_page > 0) {
				href_value = '/users_management?page=' + (current_page+1);
			}
			$(a).prop('href', href_value);
		}

		function prev_button_click(a) {
			current_page = parseInt($('.pagination').find('.active').text());
			href_value = '/users_management?page=' + (current_page-1);
			$(a).prop('href', href_value);
		}

		function disabled_element(id) {
			if ($(id).attr("disabled")) {
				$(id).on("click", function() {
					return false; 
				});
			} else {
				$(id).removeAttr("disabled").off("click");
			}
		}
	</script>

</div>

{% end %}